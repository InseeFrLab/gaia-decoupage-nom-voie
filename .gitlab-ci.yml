variables:
  PYTHON_VERSION: "3.11"
  HTTP_PROXY: http://proxy-app.insee.fr:3128
  HTTPS_PROXY: http://proxy-app.insee.fr:3128
  NO_PROXY: ".insee.fr,.insee.eu,.insee.intra,localhost,insee.test"
  NEXUS_URL: "https://nexus.insee.fr"
  DEPOT_DEPENDANCES: "https://nexus.insee.fr/repository/pypi-proxy/pypi"
  DEPOT_DEPENDANCES_INDEX: "https://nexus.insee.fr/repository/pypi-proxy/simple/"
  DEPOT_LIVRAISON: "https://nexus.insee.fr/repository/pypi-internal/"

default:
  tags:
    - docker

stages:
  - build
  - test

build:
  image: python:$PYTHON_VERSION
  stage: build
  before_script:
    - pip config set global.trusted-host nexus.insee.fr 
    - pip config set global.index ${DEPOT_DEPENDANCES}
    - pip config set global.index-url ${DEPOT_DEPENDANCES_INDEX}
    - pip install poetry
    - poetry config certificates.nexus.cert false
  script:
      # Définition du dépôt contenant les dépendances
    - poetry source add nexus ${DEPOT_DEPENDANCES_INDEX} --priority=primary
      # Installation des dépendances
    - poetry install
    - poetry add poetry-plugin-export
    - poetry config warnings.export false
      # Génération de requirements.txt
    - poetry export --output requirements.txt --without-hashes
      # Génération de requirements-dev.txt
    - poetry export --output requirements-dev.txt --without-hashes --with dev
      # Création du livrable sous dist
    - poetry build

pages:
  stage: build
  image: gitlab-registry.insee.fr:443/kubernetes/images/build/node:18
  before_script:
    - npm install --global retypeapp
  script:
    - 'retype build --override "{ \"url\": \"$CI_PAGES_URL\" }" --output $CI_PROJECT_DIR/public'
  artifacts:
    paths:
      - public

test:
  image: python:$PYTHON_VERSION
  stage: test
  before_script:
    - pip config set global.trusted-host nexus.insee.fr 
    - pip config set global.index ${DEPOT_DEPENDANCES}
    - pip config set global.index-url ${DEPOT_DEPENDANCES_INDEX}
    - pip install poetry
  script:
    - poetry config certificates.nexus.cert false
    - poetry add pytest
    - poetry run pytest

